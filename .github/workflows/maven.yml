name: build and deploy Peon AI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B clean verify --file pom.xml

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Build update site
      run: mvn -B clean verify --file pom.xml

    - name: Deploy to GitHub Pages
      run: |
        # Save built repository to temp
        cp -r releng/llmpeon-update-site/target/repository /tmp/p2-repo
        # Switch to gh-pages branch
        git checkout gh-pages
        # Delete all existing files except .git
        find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} \;
        # Copy new p2 repository content
        cp -r /tmp/p2-repo/* .
        # Commit and push
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git commit -m "Update p2 repository" || echo "No changes to commit"
        git push origin gh-pages --force
